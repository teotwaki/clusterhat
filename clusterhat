#!/bin/env bash
# ClusterHAT controller

GPIO_LED="21"
GPIO_P1="22"
GPIO_P2="23"
GPIO_P3="24"
GPIO_P4="25"
GPIO_ON="1"
GPIO_OFF="0"

gpio_enable() {
  local address="$1"
  gpio write "$address" "$GPIO_ON"
}

gpio_disable() {
  local address="$1"
  gpio write "$address" "$GPIO_OFF"
}

led_enable() {
  gpio_enable "$GPIO_LED"
}

led_disable() {
  gpio_disable "$GPIO_LED"
}

if [ $# -gt 0 ];then
  MODE=$1
else
  echo
  echo "Usage:"
  echo " $0 <action> [<device>] [<device>]"
  echo " action = on / off"
  echo " device = all / p1 / p2 / p3 / p4"
  echo " If device is missing the action will be performed on all devices"
  echo
  echo "Examples:"
  echo "$0 on p1 p3 # Turns on P1 and P3"
  echo "$0 off all # Turns off P1-4"
  echo
  exit
fi

if [ $# -gt 1 ]; then
  devices=("$@")
else
  devices=("all")
fi

function contains() {
  local n=$#
  local value=${!n}
  for ((i=1;i < $#;i++)) {
    if [ "${!i}" == "${value}" ]; then
      echo "y"
      return 0
    fi
  }
  echo "n"
  return 1
}

if [ "$MODE" = "on" ]; then
  # Turn "Alert" LED on whilst we're running
  led_enable

  if [[ $(contains "${devices[@]}" "all") == "y" ]] || [[ $(contains "${devices[@]}" "p1") == "y" ]];then
    echo "Turning on P1"
    gpio_enable "$GPIO_P1"
    sleep 2
  fi

  if [[ $(contains "${devices[@]}" "all") == "y" ]] || [[ $(contains "${devices[@]}" "p2") == "y" ]];then
    echo "Turning on P2"
    gpio_enable "$GPIO_P2"
    sleep 2
  fi

  if [[ $(contains "${devices[@]}" "all") == "y" ]] || [[ $(contains "${devices[@]}" "p3") == "y" ]];then
    echo "Turning on P3"
    gpio_enable "$GPIO_P3"
    sleep 2
  fi

  if [[ $(contains "${devices[@]}" "all") == "y" ]] || [[ $(contains "${devices[@]}" "p4") == "y" ]];then
    echo "Turning on P4"
    gpio_enable "$GPIO_P4"
    sleep 2
  fi

  # Turn "Alert" LED off
  led_disable

elif [ "$MODE" = "off" ];then
  # Turn "Alert" LED on whilst we're running
  led_enable

  if [[ $(contains "${devices[@]}" "all") == "y" ]] || [[ $(contains "${devices[@]}" "p1") == "y" ]];then
    echo "Turning off P1"
    gpio_enable "$GPIO_P1"
  fi

  if [[ $(contains "${devices[@]}" "all") == "y" ]] || [[ $(contains "${devices[@]}" "p2") == "y" ]];then
    echo "Turning off P2"
    gpio_enable "$GPIO_P2"
  fi

  if [[ $(contains "${devices[@]}" "all") == "y" ]] || [[ $(contains "${devices[@]}" "p3") == "y" ]];then
    echo "Turning off P3"
    gpio_enable "$GPIO_P3"
  fi

  if [[ $(contains "${devices[@]}" "all") == "y" ]] || [[ $(contains "${devices[@]}" "p4") == "y" ]];then
    echo "Turning off P4"
    gpio_enable "$GPIO_P4"
  fi

  # Turn "Alert" LED off
  led_disable
else
  echo "ERROR: Unknown Mode"
  exit
fi
