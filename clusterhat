#!/bin/env bash
# ClusterHAT controller

gpio_base_address="21"
rampup_delay=2
force_write=false
controller_mode=
controller_devices=

error() {
  echo "$*" 1>&2
}

fatal_error() {
  error $*
  exit -1
}

cli_error() {
  error $*
  usage
  exit -2
}

gpio_enable() {
  local address="$1"
  if [[ $(gpio read "$address") == 0 || $force_write == true ]]; then
    gpio write "$address" 1
    return 0
  fi
  return 1
}

gpio_disable() {
  local address="$1"
  if [[ $(gpio read "$address") == 1 || $force_write == true ]]; then
    gpio write "$address" 0
    return 0
  fi
  return 1
}

led_enable() {
  if ! gpio_enable "$gpio_base_address"; then
    echo "LED already turned on. Skipping."
  fi
}

led_disable() {
  if ! gpio_disable "$gpio_base_address"; then
    echo "LED already turned off. Skipping."
  fi
}

pizero_enable() {
  local index="$1"

  if [[ $index < 1 || $index > 4 ]]; then
    fatal_error "Invalid pizero index value: '$index'"
  fi

  echo "Turning on P$index"
  if ! gpio_enable "$(($gpio_base_address + $index))"; then
    echo "P$index already turned on. Skipping."
  fi
}

pizero_disable() {
  local index="$1"

  if [[ $index < 1 || $index > 4 ]]; then
    fatal_error "Invalid pizero index value: '$index'"
  fi

  echo "Turning off P$index"
  if ! gpio_disable "$(($gpio_base_address + $index))"; then
    echo "P$index already turned off. Skipping."
  fi
}

usage() {
  echo
  echo "Usage: $0 <action> [<device>] [<device>] ..."
  echo "  action = on / off"
  echo "  device = all / p1 / p2 / p3 / p4"
  echo
  echo "Examples:"
  echo "  $0 on p1 p3 # Turns on P1 and P3"
  echo "  $0 off all # Turns off P1-4"
}

parse_arguments() {
  if [[ $# < 2 ]]; then
    usage
    exit 1
  fi

  controller_mode=${1,,}

  if [[ $controller_mode != "on" && $controller_mode != "off" ]]; then
    cli_error "Unknown mode: '$1'"
  fi

  shift

  while (("$#")); do
    local arg=${1,,}
    if [[ $arg == "all" ]]; then
      controller_devices="1 2 3 4"
      break
    elif [[ $arg =~ ^p([0-9])$ ]]; then
      controller_devices="$controller_devices ${BASH_REMATCH[1]}"
    else
      cli_error "Invalid pizero identifier: '$1'"
    fi
    shift
  done

  controller_devices=$(tr " " "\n" <<< "$controller_devices" | sort -u)
}

run() {
  # Turn "Alert" LED on whilst we're running
  led_enable

  for device in $controller_devices; do
    if [[ $controller_mode == "on" ]]; then
      pizero_enable "$device"
    else
      pizero_disable "$device"
    fi

    if [[ $(wc -w <<< "$controller_devices") > 1 ]]; then
      sleep "$rampup_delay"
    fi
  done

  # Turn "Alert" LED off
  led_disable
}

parse_arguments $*
run
